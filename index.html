<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>CO₂ Table Trainer</title>
<style>
  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: #002b44;
    color: #cce7ff;
    margin: 0;
    padding: 0;
    display: flex;
    flex-direction: column;
    align-items: center;
  }
  .circle-timer {
    position: relative;
    width: 280px;
    height: 280px;
    margin-top: 1rem;
  }
  svg {
    transform: rotate(-90deg);
  }
  .circle-fill {
    fill: rgba(34, 103, 153, 0.15);
  }
  .circle-bg {
    stroke: #104060;
  }
  .circle-progress {
    transition: stroke-dashoffset 1s linear;
    fill: none;
  }
  .hold-mode {
    stroke: #3db7e4;
    animation: pulseBlue 2s infinite;
  }
  .breath-mode {
    stroke: #7bd3ff;
    animation: pulseGreen 2s infinite;
  }
  @keyframes pulseBlue {
    0%, 100% { stroke-opacity: 1; }
    50% { stroke-opacity: 0.6; }
  }
  @keyframes pulseGreen {
    0%, 100% { stroke-opacity: 1; }
    50% { stroke-opacity: 0.6; }
  }
  .circle-text {
    position: absolute;
    top: 50%;
    left: 50%;
    width: 180px;
    height: 180px;
    transform: translate(-50%, -50%);
    text-align: center;
    user-select: none;
    display: flex;
    flex-direction: column;
    justify-content: center;
  }
  .status-text {
    font-size: 2.4rem;
    font-weight: 600;
    margin-bottom: 0.1rem;
  }
  .countdown-text {
    font-size: 3.2rem;
    font-weight: 400;
    line-height: 1;
    letter-spacing: 0.05em;
  }
  .round-text {
    font-size: 1.5rem;
    font-weight: 600;
    margin-top: 0.1rem;
    opacity: 0.8;
  }
  .hold-text {
    color: #3db7e4;
    text-shadow: 0 0 10px #3db7e4;
  }
  .breath-text {
    color: #7bd3ff;
    text-shadow: 0 0 12px #7bd3ff;
  }
  .controls {
    margin-top: 2rem;
    text-align: center;
  }
  .start-btn, .pause-btn {
    padding: 0.5rem 1rem;
    margin: 0.5rem;
    font-size: 1rem;
    background: #3db7e4;
    color: #002b44;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-weight: 600;
    transition: background 0.3s ease;
  }
  .start-btn:hover, .pause-btn:hover {
    background: #66c2ff;
  }
  .inputs {
    margin-top: 2rem;
    color: #cce7ff;
    user-select: none;
  }
  .inputs input {
    margin: 0.3rem;
    padding: 0.4rem;
    border: none;
    border-radius: 3px;
    width: 70px;
    text-align: center;
    font-family: monospace;
  }
  .flow-bar {
    margin-top: 20px;
    width: 220px;
    height: 8px;
    display: flex;
    gap: 2px;
  }
  .flow-segment {
    flex-grow: 1;
    border-radius: 3px;
    opacity: 0.3;
    transition: opacity 0.3s ease;
  }
  .hold-segment {
    background: #3db7e4;
  }
  .breath-segment {
    background: #7bd3ff;
  }
  .current-segment {
    opacity: 1;
    box-shadow: 0 0 8px rgba(123, 211, 255, 0.9);
  }
  #stickerContainer {
    margin-top: 20px;
    display: flex;
    gap: 6px;
    flex-wrap: wrap;
  }
  .sticker {
    font-size: 28px;
    cursor: default;
    user-select: none;
    transition: transform 0.3s ease;
  }
  .sticker:hover {
    transform: scale(1.3);
  }
</style>
</head>
<body>

<div class="circle-timer">
  <svg width="280" height="280">
    <circle r="125" cx="140" cy="140" class="circle-fill" />
    <circle r="125" cx="140" cy="140" stroke-width="12" fill="none" class="circle-bg"/>
    <circle r="125" cx="140" cy="140" stroke-width="12" fill="none" id="progress" class="circle-progress"/>
  </svg>
  <div class="circle-text">
    <div id="statusText" class="status-text">Ready</div>
    <div id="countdownText" class="countdown-text">0:00</div>
    <div id="roundText" class="round-text"></div>
  </div>
</div>

<div class="flow-bar" id="flowBar"></div>

<div class="controls">
  <button class="start-btn" id="startStopBtn">Start</button>
  <button class="pause-btn" id="pauseBtn" disabled>Pause</button>
</div>

//훈련기록이모지
<div id="stickerContainer"></div>

<div class="inputs">
  Hold Time (mm:ss): <input type="text" id="holdTime" value="1:30" placeholder="mm:ss"><br>
  Rest Start Time (mm:ss): <input type="text" id="restTime" value="2:00" placeholder="mm:ss"><br>
  Rounds: <input type="number" id="rounds" value="8"><br>
  Rest Decrease (sec): <input type="number" id="restDecrease" value="15"><br>
</div>

<script>
let currentRound = 0;
let interval = null;
let isPaused = false;
let remaining = 0;
let total = 0;
let callbackRef = null;
let restTime = 0;
let rounds = 0;
let restDecrease = 0;
let phase = '';
let flowSegments = [];

const circle = document.getElementById("progress");
const statusText = document.getElementById("statusText");
const countdownText = document.getElementById("countdownText");
const roundText = document.getElementById("roundText");
const startStopBtn = document.getElementById("startStopBtn");
const pauseBtn = document.getElementById("pauseBtn");
const stickerContainer = document.getElementById("stickerContainer");

const circleLength = 2 * Math.PI * 125;
circle.setAttribute('stroke-dasharray', circleLength);
circle.setAttribute('stroke-dashoffset', circleLength);

function setProgress(percent) {
  const offset = circleLength * (1 - percent);
  circle.style.strokeDashoffset = offset;
}

function resetVisuals() {
  setProgress(0);
  circle.classList.remove('hold-mode', 'breath-mode');
  statusText.textContent = 'Ready';
  statusText.classList.remove('hold-text', 'breath-text');
  roundText.textContent = '';
  countdownText.textContent = '0:00';
  updateFlowHighlight(-1);
}

function startOrStop() {
  if (startStopBtn.textContent === 'Start') {
    startTraining();
    startStopBtn.textContent = 'Stop';
    pauseBtn.disabled = false;
  } else {
    stopTraining();
    startStopBtn.textContent = 'Start';
    pauseBtn.disabled = true;
  }
}

// mm:ss -> 초 변환 함수
function parseTimeToSeconds(timeStr) {
  const parts = timeStr.split(':');
  if (parts.length === 1) {
    // 초 단위로만 입력한 경우 ex) "90"
    const secs = parseInt(parts[0]);
    return isNaN(secs) ? 0 : secs;
  } else if (parts.length === 2) {
    const mins = parseInt(parts[0]);
    const secs = parseInt(parts[1]);
    if (isNaN(mins) || isNaN(secs) || secs >= 60 || mins < 0 || secs < 0) return 0;
    return mins * 60 + secs;
  } else {
    return 0;
  }
}

function startTraining() {
  clearInterval(interval);
  interval = null;
  isPaused = false;
  pauseBtn.textContent = 'Pause';

  currentRound = 0;
  const holdInput = document.getElementById('holdTime').value.trim();
  const restInput = document.getElementById('restTime').value.trim();
  const roundsInput = document.getElementById('rounds').value;
  const restDecreaseInput = document.getElementById('restDecrease').value;

  const holdTime = parseTimeToSeconds(holdInput);
  restTime = parseTimeToSeconds(restInput);
  rounds = parseInt(roundsInput);
  restDecrease = parseInt(restDecreaseInput);

  if (holdTime <= 0 || restTime <= 0 || rounds <= 0 || restDecrease < 0) {
    alert('Please enter valid positive time values.');
    resetVisuals();
    return;
  }

  createFlowBar(rounds);

  statusText.textContent = 'Ready';
  roundText.textContent = '';
  countdownText.textContent = '0:00';
  loadStickers();
  runRound(holdTime);
}

function stopTraining() {
  clearInterval(interval);
  interval = null;
  isPaused = false;
  currentRound = 0;
  remaining = 0;
  total = 0;
  callbackRef = null;
  restTime = 0;
  rounds = 0;
  restDecrease = 0;
  phase = '';

  resetVisuals();
}

function runRound(holdTime) {
  if (currentRound >= rounds) {
    statusText.textContent = 'Done ✔';
    roundText.textContent = '';
    countdownText.textContent = '0:00';
    setProgress(0);
    playInhale();
    pauseBtn.disabled = true;
    startStopBtn.textContent = 'Start';
    updateFlowHighlight(-1);
    saveTrainingLog();
    loadStickers();
    return;
  }

  currentRound++;
  roundText.textContent = `Round ${currentRound}`;
  const segmentIndex = (currentRound - 1) * 2;
  updateFlowHighlight(segmentIndex);

  phase = 'breath';
  setModeVisual('breath');
  statusText.textContent = 'Breath';
  
  countdown(holdTime, () => {
    phase = 'hold';
    setModeVisual('hold');
    statusText.textContent = 'Hold';
    updateFlowHighlight(segmentIndex + 1);
    playInhale();
    countdown(restTime, () => {
      restTime -= restDecrease;
      if (restTime < 10) restTime = 10;
      runRound(holdTime);
    });
  });
}

function setModeVisual(mode) {
  circle.classList.remove('hold-mode', 'breath-mode');
  statusText.classList.remove('hold-text', 'breath-text');
  if (mode === 'hold') {
    circle.classList.add('hold-mode');
    statusText.classList.add('hold-text');
  } else if (mode === 'breath') {
    circle.classList.add('breath-mode');
    statusText.classList.add('breath-text');
  }
}

function countdown(seconds, callback) {
  clearInterval(interval);
  remaining = seconds;
  total = seconds;
  callbackRef = callback;
  updateVisuals();

  interval = setInterval(() => {
    if (!isPaused) {
      remaining--;
      updateVisuals();

      if (remaining > 0 && remaining % 30 === 0) {
        playSoftBeep();
      }
      if (remaining === 10) {
        playSoftBeep();
      }
      if (remaining > 0 && remaining <= 3) {
        playSoftBeep();
      }

      if (remaining <= 0) {
        clearInterval(interval);
        interval = null;
        callbackRef();
      }
    }
  }, 1000);
}

function updateVisuals() {
  const percent = remaining / total;
  setProgress(percent);

  const minutes = Math.floor(remaining / 60);
  const seconds = remaining % 60;
  const formatted = `${minutes}:${seconds.toString().padStart(2, '0')}`;

  countdownText.textContent = formatted;
}

function togglePause() {
  isPaused = !isPaused;
  pauseBtn.textContent = isPaused ? 'Resume' : 'Pause';

  if (!isPaused && remaining > 0 && interval === null) {
    interval = setInterval(() => {
      if (!isPaused) {
        remaining--;
        updateVisuals();
        if (remaining % 30 === 0) playSoftBeep();
        if (remaining === 10) playSoftBeep();
        if (remaining > 0 && remaining <= 3) playSoftBeep();
        if (remaining <= 0) {
          clearInterval(interval);
          interval = null;
          callbackRef();
        }
      }
    }, 1000);
  }

  if (isPaused && interval !== null) {
    clearInterval(interval);
    interval = null;
  }
}

function playSoftBeep() {
  const ctx = new (window.AudioContext || window.webkitAudioContext)();
  const osc = ctx.createOscillator();
  const gain = ctx.createGain();

  osc.type = 'sine';
  osc.frequency.setValueAtTime(600, ctx.currentTime);
  gain.gain.setValueAtTime(0, ctx.currentTime);
  gain.gain.linearRampToValueAtTime(0.15, ctx.currentTime + 0.02);
  gain.gain.linearRampToValueAtTime(0, ctx.currentTime + 0.15);

  osc.connect(gain);
  gain.connect(ctx.destination);
  osc.start();
  osc.stop(ctx.currentTime + 0.15);
}

function playInhale() {
  const ctx = new (window.AudioContext || window.webkitAudioContext)();
  const osc = ctx.createOscillator();
  const gain = ctx.createGain();

  osc.frequency.setValueAtTime(150, ctx.currentTime);
  osc.frequency.exponentialRampToValueAtTime(50, ctx.currentTime + 1.5);
  gain.gain.setValueAtTime(0.5, ctx.currentTime);
  gain.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime + 1.5);

  osc.connect(gain);
  gain.connect(ctx.destination);
  osc.start();
  osc.stop(ctx.currentTime + 1.5);
}

function createFlowBar(rounds) {
  const flowBar = document.getElementById('flowBar');
  flowBar.innerHTML = '';
  flowSegments = [];
  for (let i = 0; i < rounds; i++) {
    const holdDiv = document.createElement('div');
    holdDiv.classList.add('flow-segment', 'hold-segment');
    flowBar.appendChild(holdDiv);
    flowSegments.push(holdDiv);

    const breathDiv = document.createElement('div');
    breathDiv.classList.add('flow-segment', 'breath-segment');
    flowBar.appendChild(breathDiv);
    flowSegments.push(breathDiv);
  }
}

function updateFlowHighlight(index) {
  flowSegments.forEach((seg, i) => {
    seg.classList.toggle('current-segment', i === index);
  });
}

// --- 훈련 기록 저장하기 ---
function saveTrainingLog() {
  let logs = JSON.parse(localStorage.getItem('co2TrainingLogs') || '[]');
  const now = new Date();
  logs.push(now.toISOString());
  localStorage.setItem('co2TrainingLogs', JSON.stringify(logs));
}

// --- 훈련 기록 불러와서 스티커 만들기 ---
function loadStickers() {
  stickerContainer.innerHTML = '';
  let logs = JSON.parse(localStorage.getItem('co2TrainingLogs') || '[]');
  logs.forEach((log) => {
    const sticker = document.createElement('div');
    sticker.className = 'sticker';
    // 랜덤 이모지 배열
    const emojis = ['⭐', '🔥', '💧', '🌟', '🍀', '🎯', '✨', '🌈', '🎵', '🚀'];
    const emoji = emojis[Math.floor(Math.random() * emojis.length)];
    sticker.textContent = emoji;
    sticker.title = new Date(log).toLocaleString();  // 마우스 오버시 날짜 표시
    stickerContainer.appendChild(sticker);
  });
}

// --- 버튼 이벤트 연결 ---
startStopBtn.addEventListener('click', startOrStop);
pauseBtn.addEventListener('click', togglePause);

// 페이지 로드 시 스티커 표시
loadStickers();

</script>

</body>
</html>
